<!DOCTYPE html>
<html>
<head>
    <title>canvas</title>
</head>
<body>
<h1>canvas</h1>
<canvas id="canvas1" width="200" height="200">是时候更换浏览器了<a href="http://firefox.com.cn/download/">点击下载firefox</a></canvas>
<script>
    var canvas1=document.getElementById('canvas1');
    var context1=canvas1.getContext('2d');
    image=new Image();
    image.src="./cake.jpg";
    image.onload=function(){
        context1.drawImage(image,0,0);//绘制原始图像，（0,0）表示图像的左上角位与canvas画布的位置
    }
</script>
<br/>
<button onclick="reverse()">reverse</button>
<button onclick="black()">black</button>
<button onclick="brighter()">brighter</button>
<button onclick="opacity()">opacity</button>
<button onclick="red()">red</button>
<button onclick="green()">green</button>
<button onclick="oppsite()">oppsite</button>
<input type="text" id="oppsite" value="0.2">
<button onclick="download()">download</button>
<br/>
<canvas id="canvas2" width="200" height="200"></canvas>
<script>

    function reverse(){
        var canvas2=document.getElementById('canvas2');
        var context2=canvas2.getContext('2d');
        var imagedata=context1.getImageData(0,0,image.width,image.height);
        var imagedata1=context2.createImageData(imagedata);
        for(var j=0;j<image.height;j+=1)
            for(var i=0;i<image.width;i+=1){
                k=4*(image.width*j+i);
                imagedata1.data[k+0]=255-imagedata.data[k+0];
                imagedata1.data[k+1]=255-imagedata.data[k+1];
                imagedata1.data[k+2]=255-imagedata.data[k+2];
                imagedata1.data[k+3]=255;
            }
        context2.putImageData(imagedata1,0,0);
    }

    function black(){
        var canvas2=document.getElementById('canvas2');
        var context2=canvas2.getContext('2d');
        var imagedata=context1.getImageData(0,0,image.width,image.height);
        var imagedata1=context2.createImageData(image.width,image.height);
        for(var j=0;j<image.height;j+=1)
            for(var i=0;i<image.width;i+=1){
                k=4*(image.width*j+i);
                imagedata1.data[k+0]=imagedata.data[k+0];
                imagedata1.data[k+1]=imagedata.data[k+0];
                imagedata1.data[k+2]=imagedata.data[k+0];
                imagedata1.data[k+3]=255;
            }
        context2.putImageData(imagedata1,0,0);
    }

    function brighter(){
        var canvas2=document.getElementById('canvas2');
        var context2=canvas2.getContext('2d');
        var imagedata=context1.getImageData(0,0,image.width,image.height);
        var imagedata1=context2.createImageData(image.width,image.height);
        for(var j=0;j<image.height;j+=1)
            for(var i=0;i<image.width;i+=1){
                k=4*(image.width*j+i);
                imagedata1.data[k+0]=imagedata.data[k+0]+35;
                imagedata1.data[k+1]=imagedata.data[k+1]+30;
                imagedata1.data[k+2]=imagedata.data[k+2]+40;
                imagedata1.data[k+3]=255;
            }
        context2.putImageData(imagedata1,0,0);
    }

    function opacity(){
        var canvas2=document.getElementById('canvas2');
        var context2=canvas2.getContext('2d');
        var imagedata=context1.getImageData(0,0,image.width,image.height);
        var imagedata1=context2.createImageData(image.width,image.height);
        for(var j=0;j<image.height;j+=1)
            for(var i=0;i<image.width;i+=1){
                k=4*(image.width*j+i);
                imagedata1.data[k+0]=imagedata.data[k+0];
                imagedata1.data[k+1]=imagedata.data[k+1];
                imagedata1.data[k+2]=imagedata.data[k+2];
                imagedata1.data[k+3]=150;
            }
        context2.putImageData(imagedata1,0,0);
    }

    function red(){
        var canvas2=document.getElementById('canvas2');
        var context2=canvas2.getContext('2d');
        var imagedata=context1.getImageData(0,0,image.width,image.height);
        var imagedata1=context2.createImageData(image.width,image.height);
        for(var j=0;j<image.height;j+=1)
            for(var i=0;i<image.width;i+=1){
                k=4*(image.width*j+i);
                imagedata1.data[k+0]=imagedata.data[k+0]+30;
                imagedata1.data[k+1]=imagedata.data[k+1];
                imagedata1.data[k+2]=imagedata.data[k+2];
                imagedata1.data[k+3]=255;
            }
        context2.putImageData(imagedata1,0,0);
    }

    function green(){
        var canvas2=document.getElementById('canvas2');
        var context2=canvas2.getContext('2d');
        var imagedata=context1.getImageData(0,0,image.width,image.height);
        var imagedata1=context2.createImageData(image.width,image.height);
        for(var j=0;j<image.height;j+=1)
            for(var i=0;i<image.width;i+=1){
                k=4*(image.width*j+i);
                imagedata1.data[k+0]=imagedata.data[k+0];
                imagedata1.data[k+1]=imagedata.data[k+1]+30;
                imagedata1.data[k+2]=imagedata.data[k+2];
                imagedata1.data[k+3]=255;
            }
        context2.putImageData(imagedata1,0,0);
    }


    function oppsite(){
        var canvas2=document.getElementById('canvas2');
        var context2=canvas2.getContext('2d');
        var imagedata=context1.getImageData(0,0,image.width,image.height);
        var imagedata1=context2.createImageData(image.width,image.height);
        let c =  document.querySelector('#oppsite').value;
        kp = Math.tan( (45 + 44 * c) / 180 * Math.PI );
        for(var j=0;j<image.height;j+=1)
            for(var i=0;i<image.width;i+=1){
                k=4*(image.width*j+i);
                imagedata1.data[k+0] = (imagedata.data[k+0] - 127.5) * kp + 127.5;
                imagedata1.data[k+1] = (imagedata.data[k+1] - 127.5) * kp + 127.5;
                imagedata1.data[k+2] = (imagedata.data[k+2] - 127.5) * kp + 127.5;
                imagedata1.data[k+3]=255;


            }
        context2.putImageData(imagedata1,0,0);
    }

    function download(type='png') {
        var canvas2=document.getElementById('canvas2');
        //设置保存图片的类型
        var imgdata = canvas2.toDataURL(type);
        //将mime-type改为image/octet-stream,强制让浏览器下载
        var fixtype = function (type) {
            type = type.toLocaleLowerCase().replace(/jpg/i, 'jpeg');
            var r = type.match(/png|jpeg|bmp|gif/)[0];
            return 'image/' + r;
        }
        imgdata = imgdata.replace(fixtype(type), 'image/octet-stream')
        //将图片保存到本地
        var saveFile = function (data, filename) {
            var link = document.createElement('a');
            link.href = data;
            link.download = filename;
            var event = document.createEvent('MouseEvents');
            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            link.dispatchEvent(event);
        }
        var filename = new Date().getSeconds() + '.' + type;
        saveFile(imgdata, filename);
    }


</script>
</body>
</html>